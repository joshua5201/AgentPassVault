openapi: 3.0.3
info:
  title: AgentVault API
  description: Secure Secret Manager for Automated Agents
  version: 0.0.1
servers:
  - url: http://localhost:8080/api/v1
    description: Local Dev
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  headers:
    Idempotency-Key:
      description: A unique identifier for the request to prevent duplicate operations.
      schema:
        type: string
        format: uuid
security:
  - bearerAuth: []
paths:
  /auth/login/user:
    post:
      summary: User Login (Admin/Human)
      security: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLoginRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'

  /auth/login/agent:
    post:
      summary: Agent Login
      security: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentLoginRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'

  /auth/forgot-password:
    post:
      summary: Initiate Password Reset
      security: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  resetToken: { type: string }

  /auth/reset-password:
    post:
      summary: Reset Password
      security: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: OK

  /auth/ping:
    get:
      summary: Ping (Auth check)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  tenantId: { type: string, format: uuid }
                  userId: { type: string, format: uuid }
                  role: { type: string, enum: [ADMIN, AGENT] }

  /secrets:
    post:
      summary: Create Secret (Admin/Agent)
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSecretRequest'
      responses:
        '200':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecretMetadata'

  /secrets/search:
    post:
      summary: Search Secrets
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata: { type: object }
      responses:
        '200':
          description: Metadata list (values hidden)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SecretMetadata'

  /secrets/{id}:
    get:
      summary: Get Secret Value
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: leaseToken
          in: query
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Decrypted Secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Secret'
    delete:
      summary: Delete Secret (Admin)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204':
          description: Deleted

  /requests:
    post:
      summary: Create Secret Request
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRequestDTO'
      responses:
        '200':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Request'

  /requests/{id}:
    get:
      summary: Get Request Details
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Request'
    patch:
      summary: Update Request (Admin: Fulfill, Map, Reject, Approve Lease)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRequestDTO'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Request'
                  - $ref: '#/components/schemas/ApproveLeaseResponse'
    delete:
      summary: Abandon Request (Agent)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204':
          description: Abandoned

  /agents:
    get:
      summary: List Agents (Admin)
      parameters:
        - name: showAppToken
          in: query
          required: false
          schema: { type: boolean, default: false }
      responses:
        '200':
          description: Agent list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AgentResponse'
    post:
      summary: Create Agent (Admin)
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name: { type: string }
      responses:
        '200':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTokenResponse'

  /agents/{id}/rotate:
    post:
      summary: Rotate Agent Token (Admin)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: Idempotency-Key
          in: header
          required: false
          schema:
            $ref: '#/components/headers/Idempotency-Key/schema'
      responses:
        '200':
          description: Rotated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTokenResponse'

  /agents/{id}:
    delete:
      summary: Delete Agent (Admin)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204':
          description: Deleted


components:
  schemas:
    SecretVisibility:
      type: string
      enum: [VISIBLE, LEASE_REQUIRED, HIDDEN]

    SecretMetadata:
      type: object
      properties:
        secretId: { type: string, format: uuid }
        name: { type: string }
        metadata:
          type: object
          description: Combined size of metadata keys and values must not exceed 8 KB.
        visibility: { $ref: '#/components/schemas/SecretVisibility' }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    
    Secret:
      allOf:
        - $ref: '#/components/schemas/SecretMetadata'
        - type: object
          properties:
            value:
              type: string
              maxLength: 87381
              description: Encrypted secret value (max 64 KB before Base64 encoding).

    CreateSecretRequest:
      type: object
      required: [name, value]
      properties:
        name: { type: string }
        value:
          type: string
          maxLength: 87381
          description: Encrypted secret value (max 64 KB before Base64 encoding).
        metadata:
          type: object
          description: Combined size of metadata keys and values must not exceed 8 KB.

    RequestStatus:
      type: string
      enum: [pending, fulfilled, rejected, abandoned]

    RequestType:
      type: string
      enum: [CREATE, LEASE]

    Request:
      type: object
      properties:
        requestId: { type: string, format: uuid }
        status: { $ref: '#/components/schemas/RequestStatus' }
        type: { $ref: '#/components/schemas/RequestType' }
        name: { type: string }
        context:
          type: string
          maxLength: 2048
          description: Context for the request (max 2 KB).
        requiredMetadata:
          type: object
          description: Combined size must not exceed 8 KB.
        requiredFieldsInSecretValue: { type: array, items: { type: string } }
        mappedSecretId: { type: string, format: uuid }
        rejectionReason: { type: string }
        fulfillmentUrl: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreateRequestDTO:
      type: object
      required: [name]
      properties:
        name: { type: string }
        context:
          type: string
          maxLength: 2048
          description: Context for the request (max 2 KB).
        requiredMetadata:
          type: object
          description: Combined size must not exceed 8 KB.
        requiredFieldsInSecretValue: { type: array, items: { type: string } }
        type: { $ref: '#/components/schemas/RequestType' }
        secretId: { type: string, format: uuid }

    UpdateRequestDTO:
      type: object
      required: [action]
      properties:
        action:
          type: string
          enum: [FULFILL, MAP, REJECT, APPROVE_LEASE]
        name: { type: string }
        value:
          type: string
          maxLength: 87381
          description: Encrypted secret value (max 64 KB before Base64 encoding).
        metadata:
          type: object
          description: Combined size must not exceed 8 KB.
        secretId: { type: string, format: uuid }
        newVisibility: { $ref: '#/components/schemas/SecretVisibility' }
        reason: { type: string }

    ApproveLeaseResponse:
      type: object
      properties:
        leaseToken: { type: string }

    UserLoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string }
        password: { type: string }

    AgentLoginRequest:
      type: object
      required: [tenantId, appToken]
      properties:
        tenantId: { type: string, format: uuid }
        appToken: { type: string }

    LoginResponse:
      type: object
      properties:
        accessToken: { type: string }
        tokenType: { type: string }
        expiresIn: { type: integer }

    ForgotPasswordRequest:
      type: object
      required: [username]
      properties:
        username: { type: string }

    ResetPasswordRequest:
      type: object
      required: [token, newPassword]
      properties:
        token: { type: string }
        newPassword: { type: string }

    AgentResponse:
      type: object
      properties:
        agentId: { type: string, format: uuid }
        name: { type: string }
        displayName: { type: string }
        createdAt: { type: string, format: date-time }
        appToken: { type: string, nullable: true }

    AgentTokenResponse:
      type: object
      properties:
        agentId: { type: string, format: uuid }
        appToken: { type: string }
